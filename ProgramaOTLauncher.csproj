<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" Condition="Exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props')" />
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProjectGuid>{E21D451C-4724-4738-A716-DD441AD38747}</ProjectGuid>
    <OutputType>WinExe</OutputType>
    <RootNamespace>ProgramaOTLauncher</RootNamespace>
    <ApplicationIcon>icon.ico</ApplicationIcon>
    <AssemblyName>ProgramaOT-Launcher</AssemblyName>
    <TargetFrameworkVersion>v4.8</TargetFrameworkVersion>
    <FileAlignment>512</FileAlignment>
    <ProjectTypeGuids>{60dc8134-eba5-43b8-bcc9-bb4bc16c2548};{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}</ProjectTypeGuids>
    <WarningLevel>4</WarningLevel>
    <AutoGenerateBindingRedirects>true</AutoGenerateBindingRedirects>
    <Deterministic>true</Deterministic>
    <!-- Define o Runtime Identifier para resolver assets de pacotes durante Restore/Build -->
    <RuntimeIdentifiers>win</RuntimeIdentifiers>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <PlatformTarget>AnyCPU</PlatformTarget>
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <OutputPath>bin\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <PlatformTarget>AnyCPU</PlatformTarget>
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <LangVersion>8</LangVersion>
  </PropertyGroup>
  <ItemGroup>
    <ApplicationDefinition Include="src\App.xaml">
      <Generator>MSBuild:Compile</Generator>
      <SubType>Designer</SubType>
    </ApplicationDefinition>
    <Compile Include="src\App.xaml.cs">
      <DependentUpon>App.xaml</DependentUpon>
      <SubType>Code</SubType>
    </Compile>
    <Page Include="src\MainWindow.xaml">
      <Generator>MSBuild:Compile</Generator>
      <SubType>Designer</SubType>
    </Page>
    <Compile Include="src\MainWindow.xaml.cs">
      <DependentUpon>MainWindow.xaml</DependentUpon>
    </Compile>
    <Page Include="src\SplashScreen.xaml">
      <Generator>MSBuild:Compile</Generator>
      <SubType>Designer</SubType>
    </Page>
    <Compile Include="src\SplashScreen.xaml.cs">
      <DependentUpon>SplashScreen.xaml</DependentUpon>
    </Compile>
    <Page Include="src\UpdateProgressWindow.xaml">
      <Generator>MSBuild:Compile</Generator>
      <SubType>Designer</SubType>
    </Page>
    <Compile Include="src\UpdateProgressWindow.xaml.cs">
      <DependentUpon>UpdateProgressWindow.xaml</DependentUpon>
    </Compile>
    <Compile Include="src\Logger.cs" />
    <Compile Include="src\AssemblyInfo.cs" />
    <Compile Include="src\ClientConfig.cs" />
    <Compile Include="src\LauncherUpdateService.cs" />
    <Compile Include="src\UpdateConfig.cs" />
    <Compile Include="src\componentes\AtualizaCliente.cs" />
    <Compile Include="src\componentes\AtualizaLauncher.cs" />
    <Compile Include="src\componentes\PathHelper.cs" />
    <Compile Include="src\componentes\IClientUpdateListener.cs" />
  </ItemGroup>

  <ItemGroup>
    <Reference Include="System" />
    <Reference Include="System.Data" />
    <Reference Include="System.Xml" />
    <Reference Include="Microsoft.CSharp" />
    <Reference Include="System.Core" />
    <Reference Include="System.IO.Compression" />
    <Reference Include="System.IO.Compression.FileSystem" />
    <Reference Include="System.Xml.Linq" />
    <Reference Include="System.Net.Http" />
    <Reference Include="System.Data.DataSetExtensions" />
    <Reference Include="System.Xaml" />
    <Reference Include="WindowsBase" />
    <Reference Include="PresentationCore" />
    <Reference Include="PresentationFramework" />
  </ItemGroup>
  <ItemGroup>
    <!-- Referências de framework padrão -->
  </ItemGroup>

  <!-- Migrar bibliotecas para PackageReference para restaurar corretamente no CI -->
  <ItemGroup>
    <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
  </ItemGroup>

  <!-- Build do UpdaterHelper e cópia do executável sem ProjectReference (TFM incompatível com .NET Framework 4.8) -->

  <PropertyGroup>
    <!-- Caminho de saída esperado do UpdaterHelper -->
    <UpdaterHelperOutput>$(MSBuildProjectDirectory)\src\UpdaterHelper\bin\$(Configuration)\net48\UpdaterHelper.exe</UpdaterHelperOutput>
  </PropertyGroup>


  <ItemGroup>
    <Resource Include="assets\background.jpg" />
    <Resource Include="assets\bg_button_update.png" />
    <Resource Include="assets\bg_hints.png" />
    <Resource Include="assets\button_hover_play.png" />
    <Resource Include="assets\button_hover_update.png" />
    <Resource Include="assets\button_play.png" />
    <Resource Include="assets\button_update.png" />
    <Resource Include="assets\icon_play.png" />
    <Resource Include="assets\icon_update.png" />
    <Resource Include="assets\icons.xaml">
      <Generator>MSBuild:Compile</Generator>
      <SubType>Designer</SubType>
    </Resource>
    <Resource Include="assets\launcher_ico.png" />
    <Resource Include="assets\logo.png" />
    <Resource Include="assets\logo_company.png" />
    <Resource Include="assets\rh_lore.png" />
  </ItemGroup>
  <ItemGroup>

    <None Include="launcher_config.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />
  <!-- NÃO sobrescrever o alvo ResolveNuGetPackageAssets: permite que o NuGet/MSBuild resolva corretamente os assets de PackageReference -->
  
  <!-- Inputs para controlar build incremental da geração de versionlauncher.json -->
  <ItemGroup>
    <VersionLauncherInputs Include="$(MSBuildProjectDirectory)\launcher_config.json" />
    <VersionLauncherInputs Include="$(OutDir)ProgramaOT-Launcher.exe" />
  </ItemGroup>
  
  <!-- Build do projeto UpdaterHelper (se existir) -->
  <Target Name="BuildUpdaterHelperProj" AfterTargets="Build">
    <Message Text="[launcher] Build do UpdaterHelper.csproj (TFM próprio)" Importance="high" />
    <MSBuild Projects="$(MSBuildProjectDirectory)\src\UpdaterHelper\UpdaterHelper.csproj"
             Targets="Build"
             Properties="Configuration=$(Configuration)"
             Condition="Exists('$(MSBuildProjectDirectory)\src\UpdaterHelper\UpdaterHelper.csproj')" />
  </Target>

  <!-- Pós-build: copiar UpdaterHelper.exe para $(OutDir)UpdateLauncher -->
  <Target Name="CopyUpdaterHelperAfterBuild" AfterTargets="Build">
    <Message Text="[launcher] Copiando UpdaterHelper.exe para $(OutDir)UpdateLauncher" Importance="high" />
    <MakeDir Directories="$(OutDir)UpdateLauncher" />
    <Copy SourceFiles="$(UpdaterHelperOutput)" DestinationFiles="$(OutDir)UpdateLauncher\UpdaterHelper.exe" SkipUnchangedFiles="true" Condition="Exists('$(UpdaterHelperOutput)')" />
  </Target>

  <!-- Pós-build: gerar versionlauncher.json no OutDir usando launcher_config.json como fonte de versão -->
  <Target Name="GenerateVersionLauncherJsonAfterBuild" AfterTargets="Build" Inputs="@(VersionLauncherInputs)" Outputs="$(OutDir)versionlauncher.json">
    <!-- Se já existir, não regerar para acelerar builds incrementais -->
    <Message Text="[launcher] versionlauncher.json já existe — pulando geração incremental" Importance="low" Condition="Exists('$(OutDir)versionlauncher.json')" />
    <Message Text="[launcher] Gerando versionlauncher.json (fonte: launcher_config.json ou versão do executável)" Importance="high" Condition="!Exists('$(OutDir)versionlauncher.json')" />
    <Exec Command="powershell -NoProfile -ExecutionPolicy Bypass -Command &quot;$out='$(OutDir)'; $exe=Join-Path $out 'ProgramaOT-Launcher.exe'; $cfgPath=Join-Path '$(MSBuildProjectDirectory)' 'launcher_config.json'; $tag=$null; if (Test-Path $cfgPath) { $cfg=Get-Content $cfgPath -Raw | ConvertFrom-Json; if ($cfg.launcherVersion) { $tag=$cfg.launcherVersion } }; if (-not $tag) { if (Test-Path $exe) { $tag=([System.Diagnostics.FileVersionInfo]::GetVersionInfo($exe).FileVersion) } else { $tag='dev' } }; $cleanTag=$tag -replace '^(?i)v',''; $cleanTag=$cleanTag -replace '^(?i)auto-',''; $appVer=''; if (Test-Path $exe) { $appVer=([System.Diagnostics.FileVersionInfo]::GetVersionInfo($exe).FileVersion) }; $obj=@{ installedAtUtc=[DateTime]::UtcNow.ToString('o'); versionTag=$cleanTag; appFileVersion=$appVer }; $json=$obj | ConvertTo-Json -Depth 4; Set-Content -Path (Join-Path $out 'versionlauncher.json') -Value $json -Encoding UTF8;&quot;" Condition="!Exists('$(OutDir)versionlauncher.json')" />
  </Target>
  
</Project>
