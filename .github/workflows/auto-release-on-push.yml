name: Auto Release (Windows)

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: msbuild ProgramaOTLauncher.sln /t:Restore /p:RuntimeIdentifier=win

      - name: Build (Release)
        run: msbuild ProgramaOTLauncher.sln /t:Build /p:Configuration=Release /p:RuntimeIdentifier=win

      - name: Package launcher-update.zip
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $root = (Get-Location).Path
          $launcherOut = Join-Path $root 'bin' 'Release'
          $zipPath = Join-Path $root 'launcher-update.zip'
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path "$launcherOut\*" -DestinationPath $zipPath -Force

      - name: Compute timestamp tag/name
        id: vars
        shell: pwsh
        run: |
          $ts = Get-Date -Format 'yyyyMMdd-HHmm'
          # Tag e nome amigÃ¡veis baseados em data/hora
          $tag = "auto-$ts"
          $name = "Auto Release $ts"
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "name=$name" >> $env:GITHUB_OUTPUT

      - name: Generate SHA256 checksum file
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $zipPath = Join-Path (Get-Location).Path 'launcher-update.zip'
          $sha = Get-FileHash -Algorithm SHA256 -Path $zipPath
          $outFile = Join-Path (Get-Location).Path 'launcher-update.zip.sha256'
          # Formato: "hash  arquivo" (duas spaces) para compatibilidade
          Set-Content -Path $outFile -Value ("{0}  {1}" -f $sha.Hash.ToLower(), (Split-Path $zipPath -Leaf))

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.name }}
          draft: false
          prerelease: false
          files: |
            launcher-update.zip
            launcher-update.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
